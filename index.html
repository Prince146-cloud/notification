<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 350px; }
        #btn { background-color: #1877f2; color: white; border: none; padding: 15px 25px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; transition: background 0.3s; }
        #btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; font-size: 13px; color: #65676b; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin-top:0">Security Check</h2>
        <p style="color:#606770">Click the button to verify you are a human.</p>
        <button id="btn">I AM NOT A ROBOT</button>
        <p id="status">Initializing system...</p>
    </div>

    <script>
        // Your Supabase Configuration
        const SB_URL = "https://smikpuwdbfqcqrsbhqnf.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtaWtwdXdkYmZxY3Fyc2JocW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjMxODIsImV4cCI6MjA4NjMzOTE4Mn0.-s4dG3cfhcgqAVoP1UG3DZDm8gNnzqvdIZZylKTpg98";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const btn = document.getElementById('btn');
        const status = document.getElementById('status');

        // Helper: Convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
        }

        async function startVerification() {
            try {
                btn.disabled = true;
                status.innerText = "Requesting browser permission...";

                // 1. Request Permission
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error("Permission denied. Please click the lock icon in the URL bar and reset permissions.");
                }

                // 2. Register the Service Worker
                status.innerText = "Registering secure worker...";
                const registration = await navigator.serviceWorker.register('/sw.js');
                
                // 3. Subscribe to Push
                status.innerText = "Generating secure token...";
                // Use a standard public VAPID key (example)
                const publicVapidKey = 'BEl62i_E_07WvyLceLdaEJKmAr9vA06N1-067v0N8pI_R8l62i_E_07WvyLceLdaEJKmAr9vA06N1-067v0N8pI';
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                });

                // 4. Save to Supabase
                status.innerText = "Connecting to Supabase...";
                
                // We check for a session
                const { data: { user } } = await _supabase.auth.getUser();

                if (!user) {
                    // If no user, we'll just log it for now. 
                    // Usually, you'd want them to be logged in.
                    console.log("Subscription generated:", JSON.stringify(subscription));
                    status.innerHTML = "<b>Verified!</b><br>But you aren't logged in to Supabase.";
                } else {
                    const { error } = await _supabase
                        .from('profiles')
                        .update({ push_subscription: subscription })
                        .eq('id', user.id);

                    if (error) throw error;
                    status.innerHTML = "<span style='color:green'>âœ… Verification Successful!</span>";
                }

            } catch (err) {
                console.error(err);
                status.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
                btn.disabled = false;
            }
        }

        btn.onclick = startVerification;

        // Check if browser supports push
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            btn.disabled = true;
            status.innerText = "Browser not supported.";
        } else {
            status.innerText = "System Ready.";
        }
    </script>
</body>
</html>
